groups:
  # ============================================================================
  # .NET Application Alerts
  # ============================================================================
  - name: dotnet-application
    rules:
      - alert: HighErrorRate
        expr: >
          (
            sum(rate(http_server_request_duration_seconds_count{http_response_status_code=~"5.."}[5m]))
            /
            sum(rate(http_server_request_duration_seconds_count[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High HTTP 5xx error rate ({{ $value | humanizePercentage }})"
          description: "More than 5% of requests are returning 5xx status codes."

      - alert: HighRequestLatencyP95
        expr: >
          histogram_quantile(0.95,
            sum(rate(http_server_request_duration_seconds_bucket[5m])) by (le)
          ) > 2.0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "P95 request latency above 2 seconds ({{ $value }}s)"

      - alert: HighRequestLatencyP99
        expr: >
          histogram_quantile(0.99,
            sum(rate(http_server_request_duration_seconds_bucket[5m])) by (le)
          ) > 5.0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "P99 request latency above 5 seconds ({{ $value }}s)"

      - alert: HighGCPauseTime
        expr: >
          rate(dotnet_gc_pause_time_seconds_total[5m]) > 0.10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "GC is pausing more than 10% of the time"

      - alert: ThreadPoolQueueGrowing
        expr: dotnet_thread_pool_queue_length > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Thread pool queue length is {{ $value }}"

  # ============================================================================
  # Infrastructure Alerts
  # ============================================================================
  - name: infrastructure
    rules:
      - alert: HighCpuUsage
        expr: >
          100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU usage above 85%"

      - alert: LowMemoryAvailable
        expr: >
          (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 < 15
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Available memory below 15%"

      - alert: LowDiskSpace
        expr: >
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Disk space below 10%"

  # ============================================================================
  # Database Alerts
  # ============================================================================
  - name: database
    rules:
      - alert: PostgreSQLHighConnections
        expr: pg_stat_activity_count > 150
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL has {{ $value }} active connections"

      - alert: PostgreSQLSlowQueries
        expr: pg_stat_statements_mean_exec_time_seconds > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL average query time above 5s"

  # ============================================================================
  # Redis Alerts
  # ============================================================================
  - name: redis
    rules:
      - alert: RedisHighMemoryUsage
        expr: >
          redis_memory_used_bytes / redis_memory_max_bytes > 0.85
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Redis memory usage above 85%"

      - alert: RedisHighEvictionRate
        expr: rate(redis_evicted_keys_total[5m]) > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Redis evicting {{ $value }} keys/sec"
